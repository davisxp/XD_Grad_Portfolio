<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Model Viewer</title>
  <meta name="description" content="Live preview of portfolio spreadsheets with formula inspector" />
  <style>
    :root{
      --bg:#0b0c0f; --panel:#141821; --muted:#7f8aa3; --border:#202636; --text:#e7eaf0; --accent:#5bb98b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans";
    }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#ffffff; --panel:#f7f8fb; --muted:#515f7a; --border:#e7eaf0; --text:#0b0c0f; --accent:#17664b; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:auto 1fr;
    }
    header{
      display:flex; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, var(--panel), transparent 100%);
      position:sticky; top:0; z-index:10;
    }
    h1{margin:0; font-size:16px; font-weight:600}
    .spacer{flex:1}
    .btn, select, input[type="text"]{
      background:transparent; color:var(--text); border:1px solid var(--border); border-radius:10px;
      padding:8px 10px; font-size:14px; text-decoration:none;
    }
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:var(--accent); color:white; border-color:var(--accent)}
    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px}
    main{display:grid; grid-template-columns:1fr 320px; gap:14px; padding:14px; min-height:0}
    aside{
      border-left:1px solid var(--border); padding-left:14px;
      display:flex; flex-direction:column; gap:12px; min-height:0;
    }
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      padding:12px; min-height:0;
    }
    .panel h2{margin:0 0 8px 0; font-size:14px}
    .meta{color:var(--muted); font-size:12px}
    #sheetWrap{background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:auto; min-height:0}
    table{border-collapse:collapse; font-size:13px; font-family:var(--mono)}
    th, td{border:1px solid var(--border); padding:6px 8px; white-space:nowrap; vertical-align:top}
    thead th{position:sticky; top:0; background:rgba(0,0,0,0.15)}
    tbody td.firstcol, thead th.firstcol{position:sticky; left:0; background:rgba(0,0,0,0.10)}
    tbody tr:nth-child(even) td{background:rgba(255,255,255,0.02)}
    .error{color:#e87d7d}
    .kv{display:grid; grid-template-columns:110px 1fr; gap:6px 10px; font-family:var(--mono); font-size:12px}
    .kv b{color:var(--muted); font-weight:600}
    code{font-family:var(--mono); font-size:12px}
    details summary{cursor:pointer; color:var(--muted)}
    .hidden{display:none}
    footer{border-top:1px solid var(--border); padding:12px 16px; color:var(--muted); font-size:12px}
    @media (max-width: 980px) {
      main{grid-template-columns:1fr}
      aside{border-left:none; padding-left:0}
    }
    /* small tweak so canvas doesn’t overflow */
    #chartCanvas{width:100%; max-height:260px}
  </style>
</head>
<body>
  <header>
    <a class="btn" href="../">Back to landing page</a>
    <h1>Live Spreadsheet Viewer</h1>
    <div class="spacer"></div>

    <div class="toolbar">
      <label class="pill">Workbook
        <select id="file"></select>
      </label>
      <label class="pill">Sheet
        <select id="sheet"></select>
      </label>
      <label class="pill"><input type="checkbox" id="showFormula"> Show formulas</label>
      <label class="pill">Filter <input id="filter" type="text" placeholder="Type to filter rows"></label>
      <button class="btn" id="copyLink">Copy link</button>
      <a class="btn primary" id="downloadLink" download>Download</a>
      <!-- NEW: full-fidelity chart/shape viewer -->
      <a class="btn" id="officeLink" target="_blank" rel="noopener">Open in Microsoft Viewer</a>
    </div>
  </header>

  <main>
    <div id="sheetWrap"><div id="status" class="meta" style="padding:10px">Loading…</div><div id="out"></div></div>

    <aside>
      <div class="panel" id="inspector">
        <h2>Cell inspector</h2>
        <div class="meta">Click any cell to inspect value and formula.</div>
        <div class="kv" id="cellInfo">
          <b>Address</b><span>–</span>
          <b>Value</b><span>–</span>
          <b>Raw</span><span>–</span>
          <b>Formula</b><span>–</span>
          <b>Type</b><span>–</span>
          <b>Format</b><span>–</span>
          <b>Hyperlink</b><span>–</span>
        </div>
      </div>

      <div class="panel" id="ranges">
        <h2>Named ranges</h2>
        <div class="meta">Workbook-level names</div>
        <div id="namesBody" class="meta">None detected.</div>
      </div>

      <div class="panel" id="sources">
        <h2>Sources</h2>
        <div class="meta">Pulled from <code>SOURCES.md</code> if present.</div>
        <div id="sourcesBody" class="meta">Looking for SOURCES.md…</div>
      </div>

      <!-- NEW: simple chart panel driven by named ranges -->
      <div class="panel" id="chartPanel">
        <h2>Chart (from named ranges)</h2>
        <div class="meta">Looks for <code>CHART_CATS</code>, <code>CHART_S1…S6</code> and optional <code>CHART_S1_NAME…S6_NAME</code> in the workbook.</div>
        <canvas id="chartCanvas" height="220"></canvas>
        <div class="meta" id="chartStatus">Waiting for workbook…</div>
        <div class="toolbar">
          <button class="btn" id="refreshChart">Refresh chart</button>
        </div>
      </div>
    </aside>
  </main>

  <footer>
    Tip: provide a “Summary” sheet in each workbook for a clean first render. Keep preview files under ~100 MB and outside Git LFS.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- NEW: Chart.js for the lightweight in-page chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // === Configure your workbooks (case-sensitive paths) ===
    const files = [
      { path: "../models/3_Statement_Model.xlsx", label: "Smith & Nephew — 3-Statement" }
      // { path: "../models/03_DCF.xlsx", label: "Smith & Nephew — DCF" },
      // { path: "../models/06_SOTP.xlsx", label: "Smith & Nephew — SOTP" },
      // { path: "../models/07_rNPV.xlsx", label: "Smith & Nephew — rNPV" },
      // { path: "../models/Valuation_Overview.xlsx", label: "Valuation Overview (charts)" }
    ];
    // =======================================================

    const fileSel   = document.getElementById('file');
    const sheetSel  = document.getElementById('sheet');
    const out       = document.getElementById('out');
    const statusEl  = document.getElementById('status');
    const showForm  = document.getElementById('showFormula');
    const filterInp = document.getElementById('filter');
    const copyBtn   = document.getElementById('copyLink');
    const dlLink    = document.getElementById('downloadLink');
    const officeA   = document.getElementById('officeLink');

    let currentWB = null, currentPath = null, currentWS = null, currentHTMLTable = null;

    // populate file dropdown
    files.forEach(f => {
      const opt = document.createElement('option');
      opt.value = f.path; opt.textContent = f.label;
      fileSel.appendChild(opt);
    });
    fileSel.value = files[0].path;

    fileSel.addEventListener('change', () => loadWorkbook(fileSel.value));
    sheetSel.addEventListener('change', () => {
      const name = sheetSel.value;
      if (!currentWB) return;
      currentWS = currentWB.Sheets[name];
      renderSheet(currentWS);
      syncLink();
      refreshChartFromNames(); // NEW: keep chart in sync when sheet changes
    });
    showForm.addEventListener('change', () => renderSheet(currentWS));
    filterInp.addEventListener('input', () => applyFilter());

    copyBtn.addEventListener('click', () => {
      const short = (currentPath||"").split('/').pop();
      const url = new URL(location.href);
      url.searchParams.set('file', short);
      url.searchParams.set('sheet', sheetSel.value);
      url.searchParams.set('f', showForm.checked ? "1":"0");
      navigator.clipboard.writeText(url.toString()).then(() => {
        status(`Link copied`);
      }).catch(() => status(`Could not copy link`));
    });

    function syncLink(){
      dlLink.href = currentPath;
      dlLink.textContent = 'Download ' + (files.find(f=>f.path===currentPath)?.label || 'workbook');
      // NEW: Office viewer deep link for full-fidelity charts/shapes
      try{
        const abs = new URL(currentPath, location.href).href;
        const ov = 'https://view.officeapps.live.com/op/view.aspx?src=' + encodeURIComponent(abs) + '&wdDownloadButton=FALSE';
        officeA.href = ov;
      }catch(_){}
    }

    function status(t){ statusEl.textContent = t; }

    async function loadWorkbook(path){
      try{
        currentPath = path;
        status('Loading workbook…');
        out.innerHTML = '';
        sheetSel.innerHTML = '';
        const res = await fetch(path, { cache: 'no-store' });
        if(!res.ok) throw new Error(`Fetch failed (${res.status}) for ${path}`);
        const buf = await res.arrayBuffer();
        currentWB = XLSX.read(buf, { type: 'array' });

        // populate sheets
        currentWB.SheetNames.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s; opt.textContent = s;
          sheetSel.appendChild(opt);
        });
        // pick Summary if present, else first
        const initial = currentWB.SheetNames.includes('Summary') ? 'Summary' : currentWB.SheetNames[0];
        sheetSel.value = initial;
        currentWS = currentWB.Sheets[initial];

        // render
        renderSheet(currentWS);
        status(`${path} • ${currentWB.SheetNames.length} sheet(s)`);

        // show workbook names
        renderNames();

        // attempt to load SOURCES.md from repo root
        loadSources();

        // update download + office links
        syncLink();

        // NEW: try to render a chart from named ranges
        refreshChartFromNames();
      }catch(e){
        out.innerHTML = `<div class="error">${e.message}</div>`;
        status('Error loading workbook');
      }
    }

    function renderSheet(ws){
      if(!ws) return;
      const ref = ws['!ref'] || 'A1:A1';
      const range = XLSX.utils.decode_range(ref);
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      // corner
      const thCorner = document.createElement('th'); thCorner.className='firstcol'; trh.appendChild(thCorner);
      for(let C=range.s.c; C<=range.e.c; ++C){
        const th = document.createElement('th');
        th.textContent = XLSX.utils.encode_col(C);
        trh.appendChild(th);
      }
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      for(let R=range.s.r; R<=range.e.r; ++R){
        const tr = document.createElement('tr');
        const rowHead = document.createElement('th'); rowHead.className='firstcol'; rowHead.textContent = (R+1); tr.appendChild(rowHead);
        for(let C=range.s.c; C<=range.e.c; ++C){
          const addr = XLSX.utils.encode_cell({r:R,c:C});
          const td = document.createElement('td');
          td.dataset.address = addr;
          const cell = ws[addr];
          if(cell){
            const txt = (showForm.checked && cell.f) ? ("="+cell.f) : XLSX.utils.format_cell(cell);
            td.textContent = txt;
            if(cell.t === 'n' && !cell.f) td.style.textAlign = 'right';
          }else{
            td.textContent = '';
          }
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      table.appendChild(tbody);

      const wrap = document.getElementById('out');
      wrap.innerHTML = '';
      wrap.appendChild(table);
      currentHTMLTable = table;

      // click-to-inspect (bugfix: attach once per render)
      table.addEventListener('click', onCellClick);
      // apply any active filter
      applyFilter();
    }

    function onCellClick(ev){
      const td = ev.target.closest('td');
      if(!td || !td.dataset.address) return;
      const addr = td.dataset.address;
      const cell = currentWS[addr] || {};
      const fmt  = XLSX.utils.format_cell(cell);
      const info = {
        Address: addr,
        Value: fmt || '',
        Raw: (cell.v!==undefined ? String(cell.v) : ''),
        Formula: (cell.f ? "="+cell.f : ''),
        Type: cell.t || '',
        Format: cell.z || '',
        Hyperlink: (cell.l && (cell.l.Target || cell.l.target)) ? (cell.l.Target || cell.l.target) : ''
      };
      const kv = document.getElementById('cellInfo');
      kv.innerHTML = '';
      Object.entries(info).forEach(([k,v])=>{
        const b = document.createElement('b'); b.textContent = k;
        const s = document.createElement('span'); s.textContent = v || '–';
        kv.appendChild(b); kv.appendChild(s);
      });
    }

    function applyFilter(){
      if(!currentHTMLTable) return;
      const q = (filterInp.value||'').toLowerCase();
      const rows = currentHTMLTable.querySelectorAll('tbody tr');
      rows.forEach(row=>{
        if(!q){ row.classList.remove('hidden'); return; }
        const text = row.textContent.toLowerCase();
        row.classList.toggle('hidden', !text.includes(q));
      });
    }

    function renderNames(){
      const dst = document.getElementById('namesBody');
      const names = (currentWB.Workbook && currentWB.Workbook.Names) || [];
      if(!names.length){ dst.textContent = 'None detected.'; return; }
      const ul = document.createElement('ul');
      names.forEach(n=>{
        const li = document.createElement('li');
        li.innerHTML = `<code>${n.Name}</code> → <code>${n.Ref || n.RefersTo || ''}</code>`;
        ul.appendChild(li);
      });
      dst.innerHTML = ''; dst.appendChild(ul);
    }

    async function loadSources(){
      const cand = ["../SOURCES.md", "../../SOURCES.md"];
      for(const url of cand){
        try{
          const r = await fetch(url, { cache:'no-store' });
          if(r.ok){
            const md = await r.text();
            document.getElementById('sourcesBody').innerHTML = marked.parse(md);
            return;
          }
        }catch(_){}
      }
      document.getElementById('sourcesBody').textContent = 'SOURCES.md not found.';
    }

    // ====== NEW: Simple chart from named ranges (Chart.js) ======
    const chartStatus = document.getElementById('chartStatus');
    const chartCanvas = document.getElementById('chartCanvas');
    const refreshBtn  = document.getElementById('refreshChart');
    let chartObj = null;

    refreshBtn.addEventListener('click', refreshChartFromNames);

    function findName(name){
      const names = (currentWB && currentWB.Workbook && currentWB.Workbook.Names) || [];
      return names.find(n => (n.Name||'').toUpperCase() === name.toUpperCase());
    }
    function parseSheetAndRange(ref){
      // Accept forms like Sheet!$A$1:$B$10 or 'My Sheet'!$C$2:$C$8 or single-cell
      const m = ref && ref.match(/^(?:'([^']+)'|([^!]+))!([$A-Z]+[$0-9]+)(?::([$A-Z]+[$0-9]+))?$/);
      if(!m) return null;
      const sheet = (m[1]||m[2]||'').replace(/''/g,"'");
      const s = XLSX.utils.decode_cell(m[3]);
      const e = XLSX.utils.decode_cell(m[4]||m[3]);
      return { sheet, s, e };
    }
    function valuesFromRange(ref){
      const pr = parseSheetAndRange(ref);
      if(!pr) return [];
      const ws = currentWB.Sheets[pr.sheet];
      if(!ws) return [];
      const out = [];
      for(let R=pr.s.r; R<=pr.e.r; ++R){
        const row = [];
        for(let C=pr.s.c; C<=pr.e.c; ++C){
          const addr = XLSX.utils.encode_cell({r:R,c:C});
          const cell = ws[addr];
          // Prefer numeric raw value if present; else formatted text
          let v = (cell && cell.v!==undefined) ? cell.v : (cell ? XLSX.utils.format_cell(cell) : '');
          row.push(v);
        }
        out.push(row.length===1 ? row[0] : row);
      }
      // Flatten 2D single-column/row to 1D
      if(out.length && !Array.isArray(out[0])) return out;
      if(out.length && Array.isArray(out[0]) && (out[0].length===1 || out.length===1)){
        return out.map(r => Array.isArray(r) ? r[0] : r);
      }
      return out;
    }

    function refreshChartFromNames(){
      if(!currentWB){ chartStatus.textContent = 'No workbook loaded.'; return; }

      const catsN = findName('CHART_CATS');
      const s1N   = findName('CHART_S1');
      // optional more series up to S6
      const series = [];
      const names  = [];
      for(let i=1;i<=6;i++){
        const r = findName('CHART_S'+i);
        if(r){
          series.push(r);
          const nm = findName('CHART_S'+i+'_NAME');
          names.push(nm ? String(valuesFromRange(nm.Ref||nm.RefersTo||'')[0]||('Series '+i)) : ('Series '+i));
        }
      }

      if(!catsN || !s1N){
        chartStatus.textContent = 'No chart ranges found. Define CHART_CATS and CHART_S1…S6 (optional) in the workbook.';
        if(chartObj){ chartObj.destroy(); chartObj = null; }
        return;
      }

      const labels = valuesFromRange(catsN.Ref || catsN.RefersTo || '');
      const datasets = [];
      series.forEach((sn, idx)=>{
        const arr = valuesFromRange(sn.Ref || sn.RefersTo || '');
        // coerce to numbers when possible
        const data = (Array.isArray(arr) ? arr : []).map(v => (typeof v==='number' ? v : parseFloat(String(v).replace(/[, ]/g,'')))).map(v => (isFinite(v)? v : null));
        datasets.push({ label: names[idx]||('Series '+(idx+1)), data, borderWidth: 1 });
      });

      try{
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(chartCanvas.getContext('2d'), {
          type: 'bar',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'top' },
              tooltip: { mode: 'index', intersect: false }
            },
            scales: { x: { ticks: { autoSkip: true, maxRotation: 0 } }, y: { beginAtZero: true } }
          }
        });
        chartStatus.textContent = `Rendered ${datasets.length} dataset(s) from named ranges.`;
      }catch(e){
        chartStatus.textContent = 'Chart error: ' + e.message;
      }
    }

    // Deep-link support
    (function initFromQuery(){
      const params = new URLSearchParams(location.search);
      const qFile  = params.get('file');
      const qSheet = params.get('sheet');
      const qF     = params.get('f');
      if(qF === '1') showForm.checked = true;

      if(qFile){
        const match = files.find(f => f.path.endsWith('/'+qFile) || f.label === qFile);
        if(match) fileSel.value = match.path;
      }
      loadWorkbook(fileSel.value).then(()=>{
        if(qSheet && currentWB.SheetNames.includes(qSheet)){
          sheetSel.value = qSheet;
          currentWS = currentWB.Sheets[qSheet];
          renderSheet(currentWS);
          refreshChartFromNames();
        }
      });
    })();
  </script>
</body>
</html>
